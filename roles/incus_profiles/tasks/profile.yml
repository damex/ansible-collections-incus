---
- name: Ensure incus profile info {{ incus_profiles_profile_name }}
  ansible.builtin.command:
    cmd: incus --project {{ incus_profiles_profile_project }} profile show {{ incus_profiles_profile_name }}
  register: incus_profiles_profile_info_state
  failed_when: false
  changed_when: false
  become: true

- name: Ensure incus profile is created {{ incus_profiles_profile_name }}
  ansible.builtin.command:
    cmd: incus --project {{ incus_profiles_profile_project }} profile create {{ incus_profiles_profile_name }}
  become: true
  changed_when: true
  when:
    - incus_profiles_profile_info_state.rc != 0
    - incus_profiles_profile_state != "absent"

- name: Ensure incus profile configuration {{ incus_profiles_profile_name }}
  ansible.builtin.command:
    cmd: incus --project {{ incus_profiles_profile_project }} profile edit {{ incus_profiles_profile_name }}
    stdin: "{{ incus_profiles_profile | to_yaml }}"
  become: true
  changed_when: true
  when: incus_profiles_profile_state != "absent"

- name: Ensure incus profile is absent {{ incus_profiles_profile_name }}
  ansible.builtin.command:
    cmd: incus --project {{ incus_profiles_profile_project }} profile delete {{ incus_profiles_profile_name }}
  become: true
  changed_when: true
  when:
    - incus_profiles_profile_state == "absent"
    - incus_profiles_profile_info_state.rc == 0
